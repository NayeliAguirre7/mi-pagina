<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados | Datos ICS 2023</title>
  <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background-color: #f4f4f4;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2c3e50;
      color: white;
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .navbar-menu {
      display: flex;
      gap: 1.5rem;
    }

    .navbar-menu a {
      color: white;
      text-decoration: none;
      font-weight: 500;
    }

    .navbar-menu a:hover {
      text-decoration: underline;
    }

    .container {
      padding: 2rem;
    }

    .filtros-globales {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .filtros-globales select {
      padding: 0.5rem;
      font-size: 1rem;
    }

    h2 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      color: #2c3e50;
    }

    .grafica-contenedor {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }

    .filtros-anio {
      min-width: 200px;
    }

    .scroll-area {
       max-height: 500px;        /* Altura máxima visible */
       overflow-y: auto;         /* Scroll vertical */
       overflow-x: hidden;       /* Evita scroll lateral */
       padding-right: 1rem;
       margin-top: 1rem;
     }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 0.5rem;
    }

    select {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    canvas {
      width: 100%;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>

  <div class="navbar">
    <a href="index.html" style="color: white; text-decoration: none;" class="navbar-title">Datos ICS 2023</a>
    <div class="navbar-menu">
      <a href="resultados.html">Resultados</a>
      <a href="indicadores.html">Indicadores</a>
      <a href="ciudades.html">Ciudades</a>
    </div>
  </div>

  <div class="container">
    <div class="filtros-globales">
      <select id="filtro-ods"></select>
    </div>

    <h2>Resultados generales y por subíndice</h2>
    <div class="grafica-contenedor">
      <div class="filtros-anio">
        <label for="filtro-anio">Año</label>
        <select id="filtro-anio"></select>
      </div>
      <div class="scroll-area">
        <canvas id="grafica-barras"></canvas>
      </div>
    </div>

    <h2>Evolución en el tiempo</h2>
    <div>
      <canvas id="grafica-lineas"></canvas>
    </div>
  </div>

  <script>
    let datos = [];
    let graficaBarras, graficaLineas;

    function actualizarFiltros() {
      const anios = [...new Set(datos.map(d => d["Año"]))].sort();
      const ods = [...new Set(datos.map(d => d["ODS"]))].sort();

      const selAnio = document.getElementById("filtro-anio");
      const selOds = document.getElementById("filtro-ods");

      selAnio.innerHTML = anios.map(a => `<option value="${a}">${a}</option>`).join("");
      selOds.innerHTML = ods.map(o => `<option value="${o}">${o}</option>`).join("");

      selAnio.addEventListener("change", actualizarGraficas);
      selOds.addEventListener("change", actualizarGraficas);

      actualizarGraficas();
    }

    function actualizarGraficas() {
      const anio = document.getElementById("filtro-anio").value;
      const ods = document.getElementById("filtro-ods").value;

      const datosFiltrados = datos.filter(d => d["Año"] === anio && d["ODS"] === ods);
      const datosLineas = datos.filter(d => d["ODS"] === ods);

      // Gráfica de barras
      const ordenados = [...datosFiltrados].sort((a, b) => parseFloat(b["Índice"]) - parseFloat(a["Índice"]));
      const canvas = document.getElementById("grafica-barras");
      canvas.height = ordenados.length * 40;
      const etiquetas = ordenados.map(d => d["Metrópoli"]);
      const valores = ordenados.map(d => parseFloat(d["Índice"]));
      const colores = ordenados.map(d => d["Metrópoli"] === "Promedio" ? "#1f4e79" : "rgba(54, 162, 235, 0.6)");

      if (graficaBarras) graficaBarras.destroy();
      graficaBarras = new Chart(document.getElementById("grafica-barras"), {
        type: "bar",
        data: {
          labels: etiquetas,
          datasets: [{
            label: "Índice por metrópoli",
            data: valores,
            backgroundColor: colores
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true, title: { display: true, text: "Índice" } },
            y: { title: { display: true, text: "Metrópoli" } }
          }
        }
      });

      // Gráfica de líneas
      const agrupados = {};
      datosLineas.forEach(d => {
        if (!agrupados[d["Metrópoli"]]) agrupados[d["Metrópoli"]] = [];
        agrupados[d["Metrópoli"]].push({ x: d["Año"], y: parseFloat(d["Índice"]) });
      });

      const datasets = Object.entries(agrupados).map(([nombre, puntos]) => ({
        label: nombre,
        data: puntos.sort((a, b) => a.x.localeCompare(b.x)),
        borderWidth: 2,
        fill: false
      }));

      if (graficaLineas) graficaLineas.destroy();
      graficaLineas = new Chart(document.getElementById("grafica-lineas"), {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { title: { display: true, text: "Año" } },
            y: { beginAtZero: true, title: { display: true, text: "Índice" } }
          }
        }
      });
    }

    Papa.parse("resultados.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(result) {
        datos = result.data;
        actualizarFiltros();
      }
    });
  </script>

</body>
</html>
